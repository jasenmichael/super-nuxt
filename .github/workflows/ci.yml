name: ci

on:
  push:
    branches:
      - main
      # - master
  pull_request:
    branches:
      - main
      # - master

jobs:
  ci:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest]
        node: [14]

    steps:
      - name: Checkout 🛎
        uses: actions/checkout@master

      - name: Setup node env 🏗
        uses: actions/setup-node@v2.1.2
        with:
          node-version: ${{ matrix.node }}

      - name: Cache node_modules 📦
        uses: actions/cache@v2
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies 👨🏻‍💻
        run: npm ci

      - name: Run linter 👀
        run: npm run lint

      # - name: List Files 👀
      #   run: ls -al
      # https://gist.github.com/syuji-higa/2d7ece221bb521fc202ae385c54d0325
      - name: Run npm run generate
        run: npm run generate

      # in .gitignore replace static/img/* with ''
      # this way
      - name: Include updated files - remove from .gitignore
        run: |
          sed -i 's/static\/img\/\*//g' .gitignore
          sed -i 's/content\/navigation.json//g' .gitignore
          sed -i 's/content\/tumblr.json//g' .gitignore

      # Deploy to local repo

      - name: Add files and push to prod
        uses: EndBug/add-and-commit@v5 # You can change this to use a specific version
        with:
          branch: prod
          message: 'add files and push to prod'
          add: '-A'
          pull_strategy: '--rebase'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      #  - name: push
      #    uses: github-actions-x/commit@v2.7
      #    with:
      #      github-token: ${{ secrets.GITHUB_TOKEN }}
      #      push-branch: prod
      #      commit-message: '${{ matrix.node-version }} adds auto-generated benchmarks and bar graph'
      #      rebase: 'true' # pull abd rebase before commit

      # - name: Deploy
      #   uses: mikeal/publish-to-github-action@master
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #     BRANCH_NAME: 'prod'
